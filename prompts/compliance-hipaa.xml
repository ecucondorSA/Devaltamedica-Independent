<?xml version="1.0" encoding="UTF-8"?>
<!--
  GPT-5 Optimized HIPAA Compliance & Security Prompt
  AltaMedica Platform - Healthcare Regulatory Standards
  Version: 1.0.0
  Last Updated: 2025-08-15
-->

<compliance_context>
  <regulatory_framework>
    <!-- Marcos regulatorios aplicables -->
    <argentina>
      - Ley 25.326: Protecci√≥n de Datos Personales
      - Ley 26.529: Derechos del Paciente (Art. 15)
      - Ley 27.706: Historia Cl√≠nica Electr√≥nica
      - RG AFIP 4291/2018: Facturaci√≥n Electr√≥nica
    </argentina>
    
    <international>
      - HIPAA (USA): PHI protection, audit trails
      - GDPR (EU): Data privacy, right to deletion
      - ISO 27001: Information security management
      - SOC2: Security, availability, confidentiality
    </international>
  </regulatory_framework>

  <reasoning_configuration>
    <!-- M√°xima precauci√≥n para compliance -->
    <reasoning_effort>high</reasoning_effort>
    <verbosity>medium</verbosity>
    <confirmation_required>
      - Cualquier operaci√≥n con PHI
      - Cambios en permisos de acceso
      - Modificaci√≥n de audit logs
      - Exportaci√≥n de datos
    </confirmation_required>
  </reasoning_configuration>

  <phi_handling>
    <identification>
      <!-- 18 identificadores HIPAA PHI -->
      <identifiers>
        - Nombres completos
        - Direcciones (m√°s espec√≠fico que estado)
        - Fechas (nacimiento, admisi√≥n, alta, muerte)
        - N√∫meros de tel√©fono
        - N√∫meros de fax
        - Emails
        - SSN/DNI/Identificaci√≥n nacional
        - N√∫meros de historia cl√≠nica
        - N√∫meros de beneficiario
        - N√∫meros de cuenta
        - N√∫meros de certificado/licencia
        - VIN y placas de veh√≠culos
        - Device identifiers
        - URLs
        - IP addresses
        - Biometric identifiers
        - Fotograf√≠as faciales
        - Cualquier identificador √∫nico
      </identifiers>
    </identification>

    <encryption_requirements>
      <at_rest>
        - Algorithm: AES-256-GCM
        - Key management: AWS KMS o Azure Key Vault
        - Database: Field-level encryption para PHI
        - Backups: Encrypted con keys separadas
      </at_rest>
      
      <in_transit>
        - Protocol: TLS 1.3 m√≠nimo
        - Certificates: Valid SSL, no self-signed en prod
        - APIs: HTTPS only, HSTS enabled
        - WebSockets: WSS with token auth
      </in_transit>
      
      <in_use>
        - Memory: Secure string handling
        - Logs: PHI sanitization antes de logging
        - Cache: Encrypted o no-PHI only
        - Sessions: HttpOnly, Secure, SameSite cookies
      </in_use>
    </encryption_requirements>
  </phi_handling>

  <audit_logging>
    <required_events>
      <!-- Eventos que DEBEN ser auditados -->
      - Login/Logout (success y failures)
      - PHI access (view, create, update, delete)
      - Permission changes
      - Data exports
      - System configuration changes
      - Prescription creation/modification
      - Appointment scheduling/changes
      - Payment processing
      - Emergency access override
    </required_events>

    <audit_record_structure>
      ```typescript
      interface AuditLog {
        id: string;                    // UUID √∫nico
        timestamp: Date;                // ISO 8601 con timezone
        userId: string;                 // Usuario que realiz√≥ acci√≥n
        userRole: UserRole;            // Rol al momento de acci√≥n
        action: AuditAction;           // Tipo de acci√≥n
        resource: string;              // Recurso afectado
        resourceId?: string;           // ID del recurso
        patientId?: string;            // Si involucra paciente
        ipAddress: string;             // IP del cliente
        userAgent: string;             // Browser/app info
        success: boolean;              // Resultado de acci√≥n
        errorMessage?: string;         // Si fall√≥
        metadata?: Record<string, any>; // Datos adicionales
        prevHash?: string;             // Hash chain integrity
        sequenceNumber: number;        // Orden secuencial
      }
      ```
    </audit_record_structure>

    <retention_policy>
      - Audit logs: 7 a√±os m√≠nimo
      - Access logs: 3 a√±os
      - System logs: 1 a√±o
      - Backup policy: 3-2-1 rule
      - Deletion: Secure overwrite
    </retention_policy>
  </audit_logging>

  <access_control>
    <rbac_model>
      <!-- Role-Based Access Control -->
      <roles>
        - SUPER_ADMIN: Full system access
        - ADMIN: Administrative functions
        - DOCTOR: Medical records, prescriptions
        - NURSE: Limited medical records
        - PATIENT: Own records only
        - COMPANY_ADMIN: Company employees only
        - AUDITOR: Read-only audit access
      </roles>
      
      <principles>
        - Least privilege: M√≠nimo acceso necesario
        - Separation of duties: Roles no conflictivos
        - Need to know: Solo informaci√≥n relevante
        - Time-based: Acceso temporal cuando aplique
      </principles>
    </rbac_model>

    <authentication>
      - Multi-factor authentication para roles m√©dicos
      - Session timeout: 15 minutos inactividad
      - Password policy: 12+ chars, complexity rules
      - Account lockout: 5 intentos fallidos
      - Token rotation: JWT refresh cada 15 min
    </authentication>
  </access_control>

  <data_integrity>
    <validation_rules>
      - Input sanitization: XSS, SQL injection prevention
      - Schema validation: Zod en frontend y backend
      - Business logic: Doble validaci√≥n cr√≠tica
      - Checksum: Para archivos y exports
      - Version control: Para documentos m√©dicos
    </validation_rules>

    <backup_strategy>
      - Frequency: Incremental diario, full semanal
      - Testing: Restore test mensual
      - Locations: Geogr√°ficamente distribuido
      - Encryption: Backup encriptado independiente
      - Documentation: Procedimientos de recovery
    </backup_strategy>
  </data_integrity>

  <incident_response>
    <breach_protocol>
      1. Identificaci√≥n y contenci√≥n inmediata
      2. Evaluaci√≥n de impacto y alcance
      3. Notificaci√≥n a autoridades (72 horas)
      4. Notificaci√≥n a afectados (sin delay)
      5. Investigaci√≥n forense
      6. Remediaci√≥n y prevenci√≥n
      7. Documentaci√≥n y lecciones aprendidas
    </breach_protocol>

    <emergency_access>
      - Break-glass procedure documentado
      - Justificaci√≥n requerida post-facto
      - Audit trail especial de alta prioridad
      - Notificaci√≥n autom√°tica a security team
      - Review mandatorio en 24 horas
    </emergency_access>
  </incident_response>

  <tool_preambles>
    <compliance_check>
      üîí Verificando compliance HIPAA/regulatorio...
      Evaluando: [‚úì] Encriptaci√≥n [‚úì] Audit logs [‚úì] Permisos
      Validando flujo de datos PHI...
    </compliance_check>
    
    <security_implementation>
      üõ°Ô∏è Implementando controles de seguridad:
      - Encriptaci√≥n: [ALGORITHM]
      - Autenticaci√≥n: [METHOD]
      - Autorizaci√≥n: [RBAC_RULES]
      Aplicando est√°ndares m√©dicos...
    </security_implementation>
    
    <audit_summary>
      üìä Resumen de auditor√≠a:
      - Eventos capturados: [COUNT]
      - Compliance score: [PERCENTAGE]%
      - Vulnerabilidades: [NONE/LISTA]
      - Pr√≥xima revisi√≥n: [DATE]
    </audit_summary>
  </tool_preambles>

  <testing_requirements>
    <security_tests>
      - Penetration testing trimestral
      - Vulnerability scanning semanal
      - OWASP Top 10 coverage
      - Authentication bypass attempts
      - Authorization matrix validation
    </security_tests>
    
    <compliance_tests>
      - PHI encryption verification
      - Audit trail completeness
      - Access control matrix
      - Data retention validation
      - Backup recovery drill
    </compliance_tests>
    
    <performance_impact>
      - Encryption overhead: <5% CPU
      - Audit logging: <100ms latency
      - Auth checks: <50ms
      - Maintain medical-grade SLAs
    </performance_impact>
  </testing_requirements>

  <documentation_requirements>
    - Privacy policy actualizada
    - Terms of service con HIPAA
    - BAA templates para third-parties
    - Incident response playbooks
    - Training materials para staff
    - Compliance certificates
  </documentation_requirements>
</compliance_context>